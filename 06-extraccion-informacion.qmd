---
title: "M칠todos computacionales para las ciencias sociales"
subtitle: "Extracci칩n de informaci칩n con rvest"
format: 
    revealjs:
      auto-stretch: false
      scrollable: true
css: style.css
editor: source
---

```{r}
source("code/helpers.R", encoding = "utf-8")
```

## Contenidos de la clase

Web scraping con rvest

Web scraping con rselenium

Primera parte APIs

## Produciendo datos

::: columns
::: {.column width="50%"}
<img src="imagenes/ferrari.jpg" width="400"/>
:::

::: {.column width="50%"}
::: fragment
<img src="imagenes/tractor.jpg" width="500"/>
:::
:::
:::

------------------------------------------------------------------------

## Produciendo datos

gratis != f치cil

. . .

Las fuentes de datos no tradicionales y/o web muchas veces implican un arduo trabajo de captura y procesamiento

. . .

Debemos entrenarnos para ser buenos productores de informaci칩n

. . .

### No debemos asustarnos si nos encontramos con tecnolog칤as que no conocemos bien

## Produciendo datos

::: columns
::: {.column width="50%"}
#### Existen m칠todos para extraer datos de las personas

<img src="imagenes/encuesta.png" width="400"/>
:::

::: {.column width="50%"}
::: fragment
#### Existen m칠todos para extraer datos de internet

![](imagenes/ejemplo_css.jpg){width="400"}
:::
:::
:::

::: fragment
#### Internet es una gran fuente de informaci칩n, pero debemos aprender a extraerla
:::

## Las tecnolog칤as de la web

![](imagenes/lenguajes_web.png){fig-align="center" width="50%"}

::: columns
::: {.column width="50%"}
**html**: estructura

**css**: apariencia

**javascript**: interacci칩n
:::

::: {.column width="50%"}
::: fragment
### Debemos entender lo b치sico
:::
:::
:::

## html

Nos dice d칩nde est치 la informaci칩n

![](imagenes/ejemplo_html_prropio.png){fig-align="center" width="40%"}

[Ejemplo html](https://www.w3schools.com/html/tryit.asp?filename=tryhtml_default)

## css

Le da caracter칤sticas a la estructura

![](imagenes/ejemplo_css.jpg){fig-align="center" width="40%"}

[Ejemplo css](https://www.w3schools.com/css/tryit.asp?filename=trycss_default)

## Nuestros datos

[www.letras.com](www.letras.com)

![](imagenes/pagina_letras.png){fig-align="center" width="60%"}

춰Exploremos la p치gina!

## Nuestros datos

Aprenderemos a extraer letras de canciones

. . .

Este es el paso inicial para las clases de NLP

. . .

Usaremos una p치gina est치tica, para facilitar el aprendizaje

. . .

Para sitios din치micos usaremos Selenium

## Herramientas

Trabajaremos con [rvest](https://rvest.tidyverse.org/) del [tidyverse](https://www.tidyverse.org/)

```{r, eval=FALSE}
install.packages("rvest")
library(rvest)
```

![](imagenes/logo_rvest.jpeg){fig-align="center" width="15%"}

. . .

Nos apoyaremos con una extensi칩n para chrome

-   css selector gadget
-   https://chrome.google.com/webstore/detail/selectorgadget/mhjhnkcfbdhnjickkkdbjoemdmbfginb

## Antes de seguir...

Debemos extraer la informaci칩n gentilmente

춰Revisar el archivo robots.txt!

[https://www.letras.com/robots.txt](https://www.letras.com/robots.txt)

. . .

Existe un paquete llamado `polite`, para facilitar el trabajo




## Carguemos nuestro html

```{r, echo=TRUE}
library(rvest)
library(tidyverse)
page <-  read_html("https://www.letras.com/los-prisioneros/") 
print(page)
```

## Obteniendo elementos/nodos

::: panel-tabset
## Seleccionar p치rrafos

```{r, echo = T}
parrafos <- page %>% 
  html_elements("p") 
print(parrafos)
```

## Extraer texto

```{r, echo = T}
parrafos %>% 
  html_text()

```
:::

# Busquemos letras de canciones {.center background-color="aquamarine"}

## Estrategia

![](imagenes/los_prisioneros.jpg){fig-align="center" width="60%"}

Buscaremos todas las letras de Los Prisioneros

## Estrategia

1.  Entramos a la p치gina de Los Prisioneros

2.  Buscamos los links que llevan a cada letra

3.  Entramos a cada canci칩n

4.  Extraemos la letra de la canci칩n

## Encontrando los links

Entramos a la p치gina que nos interesa

```{r, echo=TRUE}
page <-  read_html("https://www.letras.com/los-prisioneros/") 
```

. . .

Extracci칩n de links

```{r, echo=TRUE}
urls_canciones <- page %>% 
    html_elements(".songList-table-songName") %>% 
    html_attr("href")
print(urls_canciones[1:5])
```

-   **.song-name**: clase del elemento que nos interesa
-   **href**: atributo con la url

## Reconstruyendo la url

Ahora debemos unir la ra칤z de la url con los identificadores que hemos encontrado

```{r, echo=TRUE}
url_1 <-  paste0("https://www.letras.com",  urls_canciones[1]) 
print(url_1)
```

`r url_1`

## Extraer la letra

Vamos a la nueva url y seleccionamos el elemento que nos interesa

```{r, echo=TRUE}
lyric <-read_html(url_1) %>% 
      html_element(".lyric-original") %>% 
      html_text()
print(lyric)
```

```{r}
letra_prisioneros <- lyric
```

## Obtengamos el t칤tulo

```{r, echo=TRUE}
title <-read_html(url_1) %>% 
      html_element("h1") %>% 
      html_text()
print(title)

```

## Ejercicio: Doja Cat

Extraer la segunda letra y segundo t칤tulo de Doja Cat

![](imagenes/doja_cat.jpg){fig-align="center" width="50%"}

## Ejercicio: The Clash

**Queremos extraer las 10 primeras letras de los Clash y guardarlas en una lista.**

![](imagenes/the_clash.jpeg){fig-align="center" width="40%"}

El *link* inicial para acceder al listado de canciones es:

-   https://www.letras.com/the-clash/

Deber칤as usar un `for` para lograr el ejercicio

## Ejercicio: Doja Cat y The Clash

Queremos un c칩digo que permita extraer las letras de un listado de bandas

. . .

```{r, eval=FALSE, echo=TRUE}
bandas <- c("doja-cat", "the-clash")

letras <- list()
# Para cada banda
for (banda in bandas) {
  
  # Para cada letra de la banda   
  for (letra in letras_banda) {
    # extraer letra de la banda    
    
    # agregar letra a la lista general de letras
    letras = append(letras, letras_banda)
  }
  
   
}

```

## Ordenando el c칩digo

::: panel-tabset
## funciones

```{r  , echo=TRUE , `code-line-numbers`="|2-7|11-15"}
# Funci칩n para obtener urls
obtener_urls <- function(banda) {
  band_url <-  sprintf("https://www.letras.com/%s", banda)
  urls <-  read_html(band_url) %>% 
      html_elements(".songList-table-songName") %>% 
      html_attr("href")
  return(urls)
}

# Funci칩n para extraer letra
extraer_letra <- function(url) {
  lyric <-read_html(url) %>% 
      html_element(".lyric-original") %>% 
      html_text()
  return(lyric)  
}


```

## llamado a funciones

```{r, echo=TRUE, eval=FALSE}
# Ra칤z de la p치gina
root <- "https://www.letras.com"

# Usar map para crear la lista 
urls <- obtener_urls("the-clash")
full_urls <- paste0(root, urls )
lyrics <-  map(full_urls[1:10], extraer_letra)

```

## todo junto

Podemos unir todo en una funci칩n

```{r, eval=FALSE, echo=TRUE, `code-line-numbers`="|1-10|7,9|13,14" }
obtener_letras_banda <- function(banda, n_letras = 5) {

  # Ra칤z de la p치gina
  root <- "https://www.letras.com"
  
  # Usar map para crear la lista 
  urls <- obtener_urls(banda)
  full_urls <- paste0(root, urls )
  lyrics <-  map(full_urls[1:n_letras], extraer_letra)
  return(lyrics)
}

bandas <- c("doja-cat", "the-clash", "los-prisioneros")
letras <-  map(bandas, obtener_letras_banda)
```
:::

## 칔ltimo paso

쯅otan algo extra침o en la letra de Los Prisioneros?

```{r}
print(letra_prisioneros)
```

## Coming soon...

```{r, echo=TRUE}
fix_string(letra_prisioneros)
```

Esta funci칩n sigue teniendo algunos defectos 游

# 쯈u칠 pasa con las p치ginas din치micas? {.center background-color="aquamarine"}

## P치ginas din치micas

Muchas p치ginas interesantes van cargando conforme interactuamos con ellas

-   Supermercados
-   Tiendas del *retail*
-   Portales de empleo
-   Diarios
-   etc.

. . .

Veamos algunos ejemplos

## Problemas de investigaci칩n

Din치micas del mercado laboral

. . .

Monitoreo de precios para IPC

. . .

An치lisis de prensa escrita

## Selenium

Selenium nos permite automatizar la interacci칩n con los navegadores

. . .

Tendremos que usar tecnolog칤as que est치n fuera de `R`

- Selenium
- Docker
- Java

. . .

Revisaremos algunos usos m치s avanzados, para quienes est칠n interesados

. . .

Solo haremos una demostraci칩n. Si quieren profundizar, pueden seguir estas documentaciones

- [Documentaci칩n 1](https://docs.ropensci.org/RSelenium/articles/basics.html) 
- [Documentaci칩n 2](https://docs.ropensci.org/RSelenium/articles/docker.html)



## Instalaci칩n

```{r, eval=FALSE, echo=T}
install.packages("Rselenium")
```

Adem치s, deben tener instalado Selenium en un contenedor o localmente 

## Seteo inicial

```{r, eval=TRUE, message=FALSE, echo=T, warning=FALSE}
library(RSelenium)
remDr <- remoteDriver(
  remoteServerAddr = "localhost",
  port = 4445L,
  browserName = "firefox"
)
remDr$open(silent = FALSE)
```

## Explorar p치ginas

P치gina de la BBC

```{r, echo=TRUE}
remDr$navigate("http://www.bbc.com")
remDr$getTitle()
```

. . . 

Ahora nos vamos a emol

```{r, echo=TRUE}
remDr$navigate("http://emol.com")
remDr$getTitle()

```

## Buscando elementos

Extraer los elementos "a"

```{r, echo=TRUE}
a_elements <- remDr$findElements(using = "css", value = "a")
length(a_elements)
```

. . . 

Para extraer el texto de uno de los elementos usamos `getElementText`

```{r, echo=TRUE}
a_elements[[60]]$getElementText()
```

. . .

## 쯀nteractuar con la p치gina?

Primero, entramos a la m치quina virtual que contiene el servicio

```{r, eval=F, echo=TRUE}

# P치gina inicial de la BBC
remDr$navigate("http://www.bbc.com")

# Encontrar el bot칩n de noticias
news <- remDr$findElement(using = "css", value = "nav.orbit-header-links:nth-child(5) > ul:nth-child(1) > li:nth-child(2) > a:nth-child(1)")

# Hacer click
news$clickElement()

# P치gina inicial de BBC
remDr$navigate("http://www.bbc.com")

# Encontrar el bot칩n de deportes
deportes <- remDr$findElement(using = "css", value = "nav.orbit-header-links:nth-child(5) > ul:nth-child(1) > li:nth-child(3) > a:nth-child(1) > span:nth-child(1)")

# Clickear en bot칩n de deportes
deportes$clickElement()



```



## Para finalizar

Es conveniente cerrar nuestra conexi칩n

```{r, echo=TRUE}
remDr$close()
```

. . .

- El *web scraping* es muy 칰til para el mundo profesional y acad칠mico

- Nos da acceso a fuentes masivas de informaci칩n (especialmente texto)

- Es un trabajo de artesan칤a que requiere paciencia y dedicaci칩n

. . .

# M칠todos computacionales para las ciencias sociales  {.center background-color="aquamarine"}


